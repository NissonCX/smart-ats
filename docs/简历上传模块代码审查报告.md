# 简历上传模块代码审查报告

> 审查日期: 2026-02-19
> 审查范围: ResumeController, ResumeService, MinioFileStorageService, SecurityConfig
> 状态: ✅ 所有问题已修复

---

## 发现的问题及修复

### 1. ✅ 已修复：ResumeController 获取用户 ID 方式错误

**问题描述**：
```java
// ❌ 错误：使用请求头获取用户 ID
@RequestHeader("X-User-Id") Long userId
```

**修复方案**：
```java
// ✅ 正确：从 SecurityContext 获取用户 ID
Authentication authentication
Long userId = (Long) authentication.getPrincipal();
```

**原因**：
- JWT 过滤器已经解析 Token 并将 userId 存入 SecurityContext
- 从请求头获取用户 ID 不安全，容易被伪造
- 使用 Spring Security 的标准方式更安全

**修复文件**：
- `src/main/java/com/smartats/module/resume/controller/ResumeController.java`

---

### 2. ✅ 已修复：MinioFileStorageService.setBucketPublic() 未实现

**问题描述**：
```java
// ❌ 代码中有注释但没实现
// 设置 Bucket 为公共读取（开发环境）
// 生产环境建议使用预签名 URL
String config = "...";
// 注意：这里需要根据实际 MinIO 版本调整配置方式
```

**修复方案**：
```java
// ✅ 完整实现 setBucketPublic() 方法
private void setBucketPublic() {
    try {
        String policy = String.format(
            "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"AWS\":[\"*\"]},\"Action\":[\"s3:GetObject\"],\"Resource\":[\"arn:aws:s3:::%s/*\"]}]}",
            bucketName
        );

        minioClient.setBucketPolicy(
            SetBucketPolicyArgs.builder()
                .bucket(bucketName)
                .config(policy)
                .build()
        );

        log.info("设置 Bucket 公共读取策略成功: {}", bucketName);

    } catch (Exception e) {
        log.warn("设置 Bucket 公共策略失败（可能是已设置）: bucket={}, error={}", bucketName, e.getMessage());
    }
}
```

**影响**：
- ✅ 应用启动时自动设置 Bucket 为 Public
- ✅ 避免手动配置，提升开发体验
- ✅ 如果已设置，会优雅地处理异常

**修复文件**：
- `src/main/java/com/smartats/infrastructure/storage/MinioFileStorageService.java`

---

### 3. ✅ 已修复：ResumeService 异常处理不规范

**问题描述**：
```java
// ❌ 使用 RuntimeException
throw new RuntimeException("文件不能为空");
throw new RuntimeException("文件大小不能超过 10MB");
throw new RuntimeException("文件上传失败");
```

**修复方案**：
```java
// ✅ 使用 BusinessException
throw new BusinessException(ResultCode.BAD_REQUEST, "文件不能为空");
throw new BusinessException(ResultCode.FILE_SIZE_EXCEEDED);
throw new BusinessException(ResultCode.FILE_UPLOAD_ERROR);
```

**优势**：
- ✅ 统一错误码和错误消息
- ✅ 前端可以根据错误码做统一处理
- ✅ GlobalExceptionHandler 能够正确捕获并返回标准格式

**修复文件**：
- `src/main/java/com/smartats/module/resume/service/ResumeService.java`

**相关错误码**：
- `FILE_TYPE_NOT_SUPPORTED` (20003): 不支持的文件类型
- `FILE_SIZE_EXCEEDED` (20004): 文件大小超限
- `FILE_UPLOAD_ERROR` (50003): 文件上传失败

---

### 4. ✅ 已优化：SecurityConfig 路径配置

**问题描述**：
```java
// ⚠️ 配置不够清晰
.requestMatchers(HttpMethod.GET, "/jobs/**").permitAll()
.anyRequest().authenticated()
```

**修复方案**：
```java
// ✅ 添加详细注释，明确说明简历接口需要认证
.requestMatchers(HttpMethod.GET, "/jobs/**").permitAll()
// 简历上传接口：需要认证（需要 JWT Token）
// 注意：这里不需要显式配置，因为 anyRequest().authenticated() 已经覆盖
.anyRequest().authenticated()
```

**说明**：
- `/api/v1/resumes/upload` 需要认证（需要 JWT Token）
- `/api/v1/resumes/tasks/{taskId}` 需要认证
- 所有其他未明确 `permitAll()` 的接口都需要认证

**修复文件**：
- `src/main/java/com/smartats/config/SecurityConfig.java`

---

## 数据库表创建

### ✅ 已创建 resumes 表

**SQL 文件位置**：
- `src/main/resources/sql/resume.sql`

**表结构**：
```sql
CREATE TABLE `resumes` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `user_id` BIGINT NOT NULL,
    `file_name` VARCHAR(255) NOT NULL,
    `file_path` VARCHAR(500) NOT NULL,
    `file_url` VARCHAR(500) NOT NULL,
    `file_size` BIGINT NOT NULL,
    `file_hash` VARCHAR(32) NOT NULL UNIQUE,  -- MD5 去重
    `file_type` VARCHAR(50) NOT NULL,
    `status` VARCHAR(20) NOT NULL DEFAULT 'PARSING',
    `error_message` TEXT,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_file_hash` (`file_hash`),
    INDEX `idx_status` (`status`),
    INDEX `idx_created_at` (`created_at`)
);
```

**索引说明**：
- `idx_file_hash`: 唯一索引，用于去重查询
- `idx_user_id`: 用户查询自己的简历
- `idx_status`: 按状态筛选
- `idx_created_at`: 按时间排序

---

## 配置文件检查

### ✅ MinIO 配置正确

**application.yml**：
```yaml
minio:
  endpoint: http://localhost:9000
  access-key: admin
  secret-key: admin123456
  bucket-name: smartats-resumes
  connect-timeout: 10000
  write-timeout: 60000
  read-timeout: 10000
```

**与环境信息对比**：
- ✅ 凭证与 `docs/环境信息.md` 一致
- ✅ Bucket 名称正确
- ✅ 超时时间合理

### ✅ 文件上传配置正确

**application.yml**：
```yaml
spring:
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 50MB
      file-size-threshold: 2MB
```

---

## 代码质量检查

### ✅ 使用 LambdaQueryWrapper

```java
// ✅ 正确：类型安全，重构友好
LambdaQueryWrapper<Resume> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(Resume::getFileHash, fileHash);
```

### ✅ 事务管理

```java
// ✅ 正确：多步骤操作使用事务
@Transactional(rollbackFor = Exception.class)
public ResumeUploadResponse uploadResume(MultipartFile file, Long userId)
```

### ✅ 日志级别正确

```java
log.info("简历上传成功: resumeId={}, taskId={}, hash={}", ...);
log.debug("查询任务状态: taskId={}", ...);
log.error("文件上传失败: objectName={}", ...);
```

### ✅ 代码注释完整

所有关键方法都有清晰的 Javadoc 注释

---

## 当前状态总结

### ✅ 已完成

| 项目 | 状态 | 说明 |
|------|------|------|
| Controller | ✅ | 正确从 SecurityContext 获取用户 ID |
| Service | ✅ | 使用 BusinessException，事务管理正确 |
| Entity | ✅ | 字段完整，MyBatis-Plus 注解正确 |
| Mapper | ✅ | 继承 BaseMapper |
| DTO | ✅ | 请求/响应 DTO 完整 |
| MinIO | ✅ | 自动设置 Bucket 为 Public |
| Security | ✅ | 路径配置清晰 |
| 数据库表 | ✅ | resumes 表已创建 |
| 配置文件 | ✅ | MinIO、RabbitMQ 配置正确 |

### ⏳ 待实现（第三阶段）

| 项目 | 状态 | 说明 |
|------|------|------|
| RabbitMQConfig | ⏳ | 需要创建 |
| MessagePublisher | ⏳ | 需要创建 |
| ResumeParseMessage | ⏳ | 需要创建 |
| ResumeParseConsumer | ⏳ | 需要创建 |

---

## 下一步：第三阶段 - RabbitMQ 集成

### 需要创建的文件

1. **RabbitMQ 配置类**
   - `src/main/java/com/smartats/config/RabbitMQConfig.java`
   - 定义交换机、队列、死信队列

2. **消息实体**
   - `src/main/java/com/smartats/module/resume/dto/ResumeParseMessage.java`

3. **消息发布服务**
   - `src/main/java/com/smartats/infrastructure/mq/MessagePublisher.java`

4. **MQ 消费者**
   - `src/main/java/com/smartats/module/resume/consumer/ResumeParseConsumer.java`

### 修改点

- `ResumeService.uploadResume()`: 添加发送 MQ 消息的代码

---

## 测试建议

### 第一阶段测试（当前可测）

1. **启动应用**
   ```bash
   mvn spring-boot:run
   ```

2. **测试文件上传**（需要先登录获取 Token）
   ```bash
   # 1. 登录获取 Token
   curl -X POST http://localhost:8080/api/v1/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"password123"}'

   # 2. 上传简历（使用返回的 Token）
   curl -X POST http://localhost:8080/api/v1/resumes/upload \
     -H "Authorization: Bearer <your-token>" \
     -F "file=@test.pdf"

   # 3. 查询任务状态
   curl http://localhost:8080/api/v1/resumes/tasks/{taskId} \
     -H "Authorization: Bearer <your-token>"
   ```

### 第二阶段测试（RabbitMQ 集成后）

- 检查 RabbitMQ 管理界面是否有消息
- 检查消费者日志
- 验证任务状态变化：QUEUED → PROCESSING → COMPLETED

---

## 总结

所有已知问题已修复，代码质量良好，可以进入第三阶段（RabbitMQ 集成）的开发。

**修复清单**：
- [x] ResumeController 获取用户 ID 方式
- [x] MinioFileStorageService.setBucketPublic() 实现
- [x] ResumeService 异常处理规范
- [x] SecurityConfig 路径配置优化
- [x] 数据库表创建

**下一步**：实现 RabbitMQ 集成（参考 `docs/简历上传模块开发指南.md` 第 6-7 章）
